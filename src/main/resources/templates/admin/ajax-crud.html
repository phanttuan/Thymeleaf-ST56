<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <title>AJAX CRUD - Category & Product</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" />
  <style>
    .pointer { cursor: pointer; }
    .table-sm td, .table-sm th { vertical-align: middle; }
  </style>
</head>
<body class="p-4">
<h2>Category CRUD (AJAX)</h2>
<div class="row g-3 mb-4">
  <div class="col-md-4">
    <form id="categoryForm">
      <input type="hidden" id="catId" />
      <div class="mb-2">
        <label class="form-label">Name</label>
        <input class="form-control" id="catName" required />
      </div>
      <div class="d-flex gap-2">
        <button type="submit" class="btn btn-primary btn-sm" id="catSaveBtn">Save</button>
        <button type="button" class="btn btn-secondary btn-sm" id="catResetBtn">Reset</button>
      </div>
    </form>
  </div>
  <div class="col-md-8">
    <table class="table table-bordered table-sm" id="catTable">
      <thead class="table-light">
        <tr><th style="width:60px">ID</th><th>Name</th><th style="width:140px">Action</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>
<hr />
<h2>Product CRUD (AJAX)</h2>
<div class="row g-3">
  <div class="col-md-5">
    <form id="productForm">
      <input type="hidden" id="prodId" />
      <div class="mb-2">
        <label class="form-label">Name</label>
        <input class="form-control" id="prodName" required />
      </div>
      <div class="mb-2">
        <label class="form-label">Price</label>
        <input type="number" step="0.01" class="form-control" id="prodPrice" required />
      </div>
      <div class="mb-2">
        <label class="form-label">Quantity</label>
        <input type="number" class="form-control" id="prodQuantity" required />
      </div>
      <div class="mb-2">
        <label class="form-label">Category</label>
        <select class="form-select" id="prodCategory" required></select>
      </div>
      <div class="d-flex gap-2">
        <button type="submit" class="btn btn-primary btn-sm" id="prodSaveBtn">Save</button>
        <button type="button" class="btn btn-secondary btn-sm" id="prodResetBtn">Reset</button>
      </div>
    </form>
  </div>
  <div class="col-md-7">
    <div class="d-flex mb-2 gap-2">
      <input class="form-control" id="prodSearch" placeholder="Search name..." />
      <select class="form-select" id="filterCategory"><option value="">All Categories</option></select>
      <button class="btn btn-outline-primary" id="btnFilter">Filter</button>
    </div>
    <table class="table table-bordered table-sm" id="prodTable">
      <thead class="table-light">
      <tr><th style="width:60px">ID</th><th>Name</th><th>Price</th><th>Qty</th><th>Category</th><th style="width:140px">Action</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>
<script>
const catApi = '/api/categories';
const prodApi = '/api/products';

// Added explicit element references (was relying on implicit globals which may not work)
const categoryForm = document.getElementById('categoryForm');
const catResetBtn = document.getElementById('catResetBtn');
const productForm = document.getElementById('productForm');
const prodResetBtn = document.getElementById('prodResetBtn');
const btnFilter = document.getElementById('btnFilter');
const prodSearch = document.getElementById('prodSearch');

// ---- Category Section ----
async function loadCategories() {
  const res = await fetch(catApi);
  const data = await res.json();
  renderCategoryRows(data);
  fillCategorySelects(data);
}
function renderCategoryRows(list) {
  const tb = document.querySelector('#catTable tbody');
  tb.innerHTML = list.map(c => `<tr data-id="${c.id}" data-name="${c.name}">\n<td>${c.id}</td><td>${c.name}</td>\n<td>\n<button class='btn btn-sm btn-warning me-1' onclick='editCategory(${c.id})'>Edit</button>\n<button class='btn btn-sm btn-danger' onclick='deleteCategory(${c.id})'>Del</button>\n</td></tr>`).join('');
}
function fillCategorySelects(list) {
  const sel = document.getElementById('prodCategory');
  const filter = document.getElementById('filterCategory');
  const opts = list.map(c => `<option value='${c.id}'>${c.name}</option>`).join('');
  sel.innerHTML = `<option value='' disabled selected>--Choose--</option>` + opts;
  const current = filter.value;
  filter.innerHTML = `<option value=''>All Categories</option>` + opts;
  if (current) filter.value = current;
}

async function saveCategory(e){
  e.preventDefault();
  const id = document.getElementById('catId').value;
  const name = document.getElementById('catName').value.trim();
  if(!name) return;
  const payload = { name };
  const method = id? 'PUT':'POST';
  const url = id? `${catApi}/${id}`: catApi;
  await fetch(url, {method, headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
  resetCategoryForm();
  loadCategories();
}
function editCategory(id){
  const row = document.querySelector(`#catTable tbody tr[data-id='${id}']`);
  document.getElementById('catId').value = id;
  document.getElementById('catName').value = row.dataset.name;
  document.getElementById('catSaveBtn').textContent = 'Update';
}
async function deleteCategory(id){
  if(!confirm('Delete category '+id+'?')) return;
  await fetch(`${catApi}/${id}`, {method:'DELETE'});
  loadCategories();
  loadProducts();
}
function resetCategoryForm(){
  document.getElementById('catForm');
  document.getElementById('catId').value='';
  document.getElementById('catName').value='';
  document.getElementById('catSaveBtn').textContent='Save';
}

// ---- Product Section ----
async function loadProducts(){
  const name = document.getElementById('prodSearch').value.trim();
  const categoryId = document.getElementById('filterCategory').value;
  const params = new URLSearchParams();
  if(name) params.append('name', name);
  if(categoryId) params.append('categoryId', categoryId);
  const res = await fetch(`${prodApi}?${params.toString()}`);
  const data = await res.json();
  // If paged (content exists) pick content, else assume array
  const list = Array.isArray(data)? data : data.content || [];
  renderProductRows(list);
}
function renderProductRows(list){
  const tb = document.querySelector('#prodTable tbody');
  tb.innerHTML = list.map(p => `<tr data-id='${p.id}' data-name='${p.name}'>\n<td>${p.id}</td><td>${p.name}</td><td>${p.price??p.unitPrice??''}</td><td>${p.quantity??''}</td><td>${p.category? p.category.name:''}</td>\n<td>\n<button class='btn btn-sm btn-warning me-1' onclick='editProduct(${p.id})'>Edit</button>\n<button class='btn btn-sm btn-danger' onclick='deleteProduct(${p.id})'>Del</button>\n</td></tr>`).join('');
}
async function saveProduct(e){
  e.preventDefault();
  const id = document.getElementById('prodId').value;
  const body = {
    name: document.getElementById('prodName').value.trim(),
    price: parseFloat(document.getElementById('prodPrice').value||0),
    quantity: parseInt(document.getElementById('prodQuantity').value||0),
    category: { id: document.getElementById('prodCategory').value }
  };
  if(!body.name) return;
  const method = id? 'PUT':'POST';
  const url = id? `${prodApi}/${id}`: prodApi;
  await fetch(url,{method, headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
  resetProductForm();
  loadProducts();
}
function editProduct(id){
  fetch(`${prodApi}/${id}`).then(r=>r.json()).then(p=>{
    document.getElementById('prodId').value = p.id;
    document.getElementById('prodName').value = p.name;
    document.getElementById('prodPrice').value = p.price ?? p.unitPrice ?? 0;
    document.getElementById('prodQuantity').value = p.quantity ?? 0;
    if(p.category) document.getElementById('prodCategory').value = p.category.id;
    document.getElementById('prodSaveBtn').textContent = 'Update';
  });
}
async function deleteProduct(id){
  if(!confirm('Delete product '+id+'?')) return;
  await fetch(`${prodApi}/${id}`, {method:'DELETE'});
  loadProducts();
}
function resetProductForm(){
  document.getElementById('prodForm');
  document.getElementById('prodId').value='';
  document.getElementById('prodName').value='';
  document.getElementById('prodPrice').value='';
  document.getElementById('prodQuantity').value='';
  document.getElementById('prodCategory').selectedIndex=0;
  document.getElementById('prodSaveBtn').textContent='Save';
}

// Wrap bindings to ensure elements exist & add safety checks
window.addEventListener('DOMContentLoaded', () => {
  if(!categoryForm) { console.error('categoryForm not found'); return; }
  categoryForm.addEventListener('submit', saveCategory);
  catResetBtn.addEventListener('click', resetCategoryForm);
  productForm.addEventListener('submit', saveProduct);
  prodResetBtn.addEventListener('click', resetProductForm);
  btnFilter.addEventListener('click', ()=> loadProducts());
  prodSearch.addEventListener('keyup', e=> { if(e.key==='Enter') loadProducts(); });
  // Initial load after binding
  loadCategories().then(loadProducts).catch(err=>console.error('Init load error', err));
});
</script>
</body>
</html>